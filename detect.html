<html>

<head>
    <meta name="robots" content="noindex,follow">
    <title>Redirecting...</title>
    <noscript>
        <meta http-equiv="refresh" content="0; url=##URL##">
    </noscript>
</head>

<body>
    <a href="meli://home" id="appTarget" style="display: none;" >Abrir Meli App</a>

    <script>
        // Native Android Browser
        // var navU = navigator.userAgent,
        //     isAndroidMobile = navU.indexOf('Android') > -1 && navU.indexOf('Mozilla/5.0') > -1 && navU.indexOf('AppleWebKit') > -1,
        //     regExAppleWebKit = new RegExp(/AppleWebKit\/([\d.]+)/),
        //     resultAppleWebKitRegEx = regExAppleWebKit.exec(navU),
        //     appleWebKitVersion = (resultAppleWebKitRegEx === null ? null : parseFloat(regExAppleWebKit.exec(navU)[1])),
        //     regExChrome = new RegExp(/Chrome\/([\d.]+)/),
        //     resultChromeRegEx = regExChrome.exec(navU),
        //     chromeVersion = (resultChromeRegEx === null ? null : parseFloat(regExChrome.exec(navU)[1])),
        //     isAndroidBrowser = isAndroidMobile && (appleWebKitVersion !== null && appleWebKitVersion >= 537) && (chromeVersion !== null && chromeVersion < 29);

        var navU = navigator.userAgent;
        // Android Mobile
        var isAndroidMobile = navU.indexOf('Android') > -1 && navU.indexOf('Mozilla/5.0') > -1 && navU.indexOf('AppleWebKit') > -1;
        // Android Browser (not Chrome)
        var regExAppleWebKit = new RegExp(/AppleWebKit\/([\d.]+)/);
        var resultAppleWebKitRegEx = regExAppleWebKit.exec(navU);
        var appleWebKitVersion = (resultAppleWebKitRegEx === null ? null : parseFloat(regExAppleWebKit.exec(navU)[1]));
        var isAndroidBrowser = isAndroidMobile && appleWebKitVersion !== null && appleWebKitVersion < 537;


        alert('isAndroidBrowser', isAndroidBrowser);

        (function detect(){
            this.redirectTimer = undefined;
            this.$targetEl = document.getElementById('appTarget');
            this.appUrl = this.$targetEl.href;
            //this.fallbackUrl = "##URL##";
            this.fallbackUrl = "http://www.mercadolibre.com.ar";

            // Facade para trigger un evento
            this.eventFire = function(el, etype) {
                if (el.fireEvent) {
                    (el.fireEvent('on' + etype));
                } else {
                    var evObj = document.createEvent('Events');
                    evObj.initEvent(etype, true, false);
                    el.dispatchEvent(evObj);
                }
            };

            this.redirectFallback = function(){
                window.location.replace(this.fallbackUrl);
            };

            this.cancelRedirectFallback = function(){
                clearTimeout(window.timerRedirect);
            };

            this.openAppWithFrame = function(){
                var $body = document.querySelector("body"),
                    $iframe = document.createElement("iframe");

                iframe.style.border = "none";
                iframe.style.width = "1px";
                iframe.style.height = "1px";
                iframe.src = this.appUrl;

                $body.appendChild(iframe);
            };

            this.bindEvents = function(){
                var that = this;

                if(window.addEventListener){
                    // Escucha el blur del window para cerrar la pestaña
                    window.addEventListener('blur', function() {
                        that.cancelRedirectFallback();
                        window.close();
                    });
                }
            };

            this.init = function(){
                // Si luego de un tiempo no se abrío la app
                // se realiza una redireccion a la version web
                this.redirectTimer = setTimeout(this.redirectFallback, 1500);

                // Inicializa listeners de eventos
                this.bindEvents();

                if(isAndroidBrowser){
                    this.openAppWithFrame();
                }else{
                    // Simula el evento click sobre un link
                    // para abrir la app
                    this.eventFire(this.$targetEl, 'click');
                }
            }

            this.init();
        })();
    </script>
</body>

</html>
