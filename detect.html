<html>

<head>
    <meta name="robots" content="noindex,follow">
    <title>Redirecting...</title>
    <noscript>
        <meta http-equiv="refresh" content="0; url=##URL##">
    </noscript>
</head>

<body>
    <a href="meli://home" id="appTarget" style="display: none;" >Abrir Meli App</a>

    <script>
        (function detect(){
            this.redirectTimer = undefined;
            this.$targetEl = document.getElementById('appTarget');
            //this.fallbackUrl = "##URL##";
            this.fallbackUrl = "http://www.mercadolibre.com.ar";

            // Facade para trigger un evento
            this.eventFire = function(el, etype) {
                if (el.fireEvent) {
                    (el.fireEvent('on' + etype));
                } else {
                    var evObj = document.createEvent('Events');
                    evObj.initEvent(etype, true, false);
                    el.dispatchEvent(evObj);
                }
            };

            this.redirectFallback = function(){
                window.location.replace(this.fallbackUrl);
            };

            this.cancelRedirectFallback = function(){
                clearTimeout(window.timerRedirect);
            };

            this.bindEvents = function(){
                var that = this;

                if(window.addEventListener){
                    // Escucha el blur del window para cerrar la pestaña
                    window.addEventListener('blur', function() {
                        that.cancelRedirectFallback();
                        window.close();
                    });
                }
            };

            this.init = function(){
                // Si luego de un tiempo no se abrío la app
                // se realiza una redireccion a la version web
                this.redirectTimer = setTimeout(this.redirectFallback, 1500);

                // Inicializa listeners de eventos
                this.bindEvents();

                // Simula el evento click sobre un link
                // para abrir la app
                this.eventFire(this.$targetEl, 'click');
            }

            this.init();
        })();
    </script>
</body>

</html>
